<!DOCTYPE html>
<html lang="lo">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∫•‡∫∞‡∫ö‡∫ª‡∫ö‡∫ï‡∫¥‡∫î‡∫ï‡∫≤‡∫°‡ªÄ‡∫á‡∫¥‡∫ô‡∫Å‡∫π‡ªâ‡∫¢‡∫∑‡∫° ‡∫Å‡∫≥‡∫°‡∫∞‡∫ö‡∫≤‡∫ô (‡∫•‡∫ô‡∫•) (Pro Version + Logo)</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Lao:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        :root {
            --primary: #1e3a8a; /* ‡∫™‡∫µ‡∫ü‡ªâ‡∫≤‡ªÄ‡∫Ç‡∫±‡ªâ‡∫° */
            --secondary: #3b82f6; /* ‡∫™‡∫µ‡∫ü‡ªâ‡∫≤‡∫™‡∫∞‡∫´‡∫ß‡ªà‡∫≤‡∫á */
            --success: #10b981; /* ‡∫™‡∫µ‡∫Ç‡∫Ω‡∫ß */
            --danger: #ef4444; /* ‡∫™‡∫µ‡ªÅ‡∫î‡∫á */
            --warning: #f59e0b; /* ‡∫™‡∫µ‡ªÄ‡∫´‡∫º‡∫∑‡∫≠‡∫á */
            --light: #f3f4f6;
            --dark: #1f2937;
            --white: #ffffff;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        body {
            font-family: 'Noto Sans Lao', sans-serif;
            background-color: var(--light);
            margin: 0;
            color: var(--dark);
        }

        /* Login Screen */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex; justify-content: center; align-items: center; z-index: 9999;
        }
        .login-box {
            background: var(--white); padding: 40px; border-radius: 20px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            width: 350px; text-align: center;
        }
        .login-logo { width: 120px; height: auto; margin-bottom: 20px; }
        .login-input {
            width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd;
            border-radius: 8px; box-sizing: border-box; font-family: inherit;
        }

        /* Main Layout */
        #main-content { display: none; padding: 20px; max-width: 1200px; margin: auto; }
        .header {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--white); padding: 20px; border-radius: 15px;
            box-shadow: var(--shadow); margin-bottom: 20px; flex-wrap: wrap;
        }
        .header-left { display: flex; align-items: center; }
        .header-logo { width: 60px; height: auto; margin-right: 15px; }

        /* Dashboard Cards */
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px; margin-bottom: 20px;
        }
        .stat-card {
            background: var(--white); padding: 20px; border-radius: 15px;
            box-shadow: var(--shadow); position: relative; overflow: hidden;
        }
        .stat-card::before {
            content: ''; position: absolute; left: 0; top: 0; height: 100%; width: 5px;
            background: var(--primary);
        }
        .stat-card h3 { margin: 0; color: #6b7280; font-size: 14px; text-transform: uppercase; }
        .stat-card .value { font-size: 24px; font-weight: bold; margin-top: 10px; color: var(--dark); }

        /* Tables & Lists */
        .content-panel {
            background: var(--white); padding: 25px; border-radius: 15px; box-shadow: var(--shadow);
        }
        .toolbar {
            display: flex; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;
        }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px; background: #f9fafb; color: #6b7280; font-weight: 600; border-radius: 8px 8px 0 0; }
        td { padding: 15px; border-bottom: 1px solid #f3f4f6; vertical-align: middle; }
        tr:hover { background-color: #f9fafb; }

        /* Buttons & Badges */
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-family: inherit; font-weight: 600; transition: 0.2s; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-danger { background: #fee2e2; color: #991b1b; }

        /* Modal */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 1000;
        }
        .modal-content {
            background: var(--white); width: 90%; max-width: 600px; margin: 50px auto;
            padding: 30px; border-radius: 20px; max-height: 85vh; overflow-y: auto;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn { from {transform: translateY(-50px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }

        /* Utilities */
        .progress-bar { height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; margin-top: 5px; }
        .progress-fill { height: 100%; background: var(--success); transition: width 0.5s; }
        .text-right { text-align: right; }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box">
        <img src="image_0.png" alt="Logo" class="login-logo">
        <h2 style="color: var(--primary); margin-top: 0;">‡ªÄ‡∫Ç‡∫ª‡ªâ‡∫≤‡∫™‡∫π‡ªà‡∫•‡∫∞‡∫ö‡∫ª‡∫ö</h2>
        <input type="text" id="user-input" class="login-input" placeholder="‡∫ä‡∫∑‡ªà‡∫ú‡∫π‡ªâ‡ªÉ‡∫ä‡ªâ (User)">
        <input type="password" id="pass-input" class="login-input" placeholder="‡∫•‡∫∞‡∫´‡∫±‡∫î‡∫ú‡ªà‡∫≤‡∫ô (Password)" onkeypress="if(event.key==='Enter') login()">
        <button class="btn btn-primary" style="width: 100%; margin-top: 20px;" onclick="login()">‡ªÄ‡∫Ç‡∫ª‡ªâ‡∫≤‡∫™‡∫π‡ªà‡∫•‡∫∞‡∫ö‡∫ª‡∫ö</button>
    </div>
</div>

<div id="main-content">
    <div class="header">
        <div class="header-left">
            <img src="image_0.png" alt="Logo" class="header-logo">
            <div>
                <h1 style="margin: 0; color: var(--primary); font-size: 24px;">‡∫•‡∫∞‡∫ö‡∫ª‡∫ö‡∫ï‡∫¥‡∫î‡∫ï‡∫≤‡∫°‡ªÄ‡∫á‡∫¥‡∫ô‡∫Å‡∫π‡ªâ‡∫¢‡∫∑‡∫° ‡∫Å‡∫≥‡∫°‡∫∞‡∫ö‡∫≤‡∫ô</h1>
                <small style="color: #6b7280;">V3.0 - Professional Edition</small>
            </div>
        </div>
        <div style="display: flex; gap: 10px; align-items: center;">
            <div id="user-info" style="font-weight: bold;"></div>
            <button class="btn btn-danger btn-sm" onclick="logout()">‡∫≠‡∫≠‡∫Å‡∫à‡∫≤‡∫Å‡∫•‡∫∞‡∫ö‡∫ª‡∫ö</button>
        </div>
    </div>

    <div id="stats" class="stats-grid"></div>

    <div class="content-panel">
        <div class="toolbar">
            <div style="display: flex; gap: 10px; flex: 1;">
                <input type="text" id="search" class="login-input" style="max-width: 250px; margin:0;" placeholder="üîç ‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤‡∫ä‡∫∑‡ªà..." onkeyup="renderTable()">
                <select id="filter" class="login-input" style="max-width: 150px; margin:0;" onchange="renderTable()">
                    <option value="all">‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î</option>
                    <option value="pending">‡∫ç‡∫±‡∫á‡∫Ñ‡ªâ‡∫≤‡∫á‡∫ä‡∫≥‡∫•‡∫∞</option>
                    <option value="paid">‡∫à‡ªà‡∫≤‡∫ç‡∫Ñ‡∫ª‡∫ö‡ªÅ‡∫•‡ªâ‡∫ß</option>
                </select>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-success" onclick="exportExcel()">üìä Export Excel</button>
                <button class="btn btn-primary" onclick="openAddModal()">+ ‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫™‡∫∞‡∫°‡∫≤‡∫ä‡∫¥‡∫Å</button>
                <button id="admin-btn" class="btn btn-dark" style="background:#4b5563; display:none;" onclick="openAdminPanel()">‚öôÔ∏è ‡∫ï‡∫±‡ªâ‡∫á‡∫Ñ‡ªà‡∫≤</button>
            </div>
        </div>

        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th width="50">#</th>
                        <th>‡∫ä‡∫∑‡ªà ‡ªÅ‡∫•‡∫∞ ‡∫ô‡∫≤‡∫°‡∫™‡∫∞‡∫Å‡∫∏‡∫ô</th>
                        <th>‡∫û‡∫∞‡ªÅ‡∫ô‡∫Å</th>
                        <th>‡∫ç‡∫≠‡∫î‡∫ä‡∫≥‡∫•‡∫∞‡ªÅ‡∫•‡ªâ‡∫ß</th>
                        <th>‡∫ç‡∫≠‡∫î‡∫Ñ‡∫ª‡∫á‡ªÄ‡∫´‡∫º‡∫∑‡∫≠</th>
                        <th>‡∫™‡∫∞‡∫ñ‡∫≤‡∫ô‡∫∞</th>
                        <th class="text-right">‡∫à‡∫±‡∫î‡∫Å‡∫≤‡∫ô</th>
                    </tr>
                </thead>
                <tbody id="list-body"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="modal" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <h2 id="modal-title" style="margin:0;">Title</h2>
            <span onclick="closeModal()" style="cursor:pointer; font-size:24px;">&times;</span>
        </div>
        <div id="modal-body"></div>
    </div>
</div>

<script>
    // --- Configuration ---
    const TARGET_AMT = 5312500; 
    const STORAGE_KEY = 'loan_app_v3_data_w_logo';
    const USERS_KEY = 'loan_app_v3_users_w_logo';

    // --- State Management ---
    let borrowers = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    let users = JSON.parse(localStorage.getItem(USERS_KEY)) || [
        { username: 'admin', password: '123', role: 'admin' },
        { username: 'staff', password: '123', role: 'staff' }
    ];
    let currentUser = null;

    // --- Login System ---
    function login() {
        const u = document.getElementById('user-input').value;
        const p = document.getElementById('pass-input').value;
        const found = users.find(x => x.username === u && x.password === p);

        if (found) {
            currentUser = found;
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            document.getElementById('user-info').innerText = `üë§ ${found.username.toUpperCase()}`;
            
            if (currentUser.role === 'admin') {
                document.getElementById('admin-btn').style.display = 'block';
            }

            if (borrowers.length === 0) seedData(); 
            updateDashboard();
            renderTable();
            
            const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000 });
            Toast.fire({ icon: 'success', title: '‡ªÄ‡∫Ç‡∫ª‡ªâ‡∫≤‡∫™‡∫π‡ªà‡∫•‡∫∞‡∫ö‡∫ª‡∫ö‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î' });
        } else {
            Swal.fire({ icon: 'error', title: '‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î', text: '‡∫ä‡∫∑‡ªà ‡∫´‡∫º‡∫∑ ‡∫•‡∫∞‡∫´‡∫±‡∫î‡∫ú‡ªà‡∫≤‡∫ô‡∫ö‡ªç‡ªà‡∫ñ‡∫∑‡∫Å‡∫ï‡ªâ‡∫≠‡∫á!' });
        }
    }

    function logout() { location.reload(); }

    function seedData() {
        for(let i=1; i<=5; i++) {
            borrowers.push({
                id: Date.now() + i,
                name: `‡∫™‡∫∞‡∫°‡∫≤‡∫ä‡∫¥‡∫Å ‡∫ï‡∫ª‡∫ß‡∫¢‡ªà‡∫≤‡∫á ${i}`,
                phone: '020-xxxxxxxx',
                dept: '‡∫Å‡∫≤‡∫ô‡ªÄ‡∫á‡∫¥‡∫ô',
                payments: []
            });
        }
        save();
    }

    function save() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(borrowers));
        localStorage.setItem(USERS_KEY, JSON.stringify(users));
        updateDashboard();
        renderTable();
    }

    function getPaid(b) { return b.payments.reduce((sum, p) => sum + Number(p.amount), 0); }

    function updateDashboard() {
        const totalUsers = borrowers.length;
        const totalCollected = borrowers.reduce((acc, b) => acc + getPaid(b), 0);
        const totalTarget = totalUsers * TARGET_AMT;
        const percent = totalTarget > 0 ? (totalCollected / totalTarget) * 100 : 0;

        document.getElementById('stats').innerHTML = `
            <div class="stat-card" style="border-left: 5px solid var(--primary);">
                <h3>üë• ‡∫™‡∫∞‡∫°‡∫≤‡∫ä‡∫¥‡∫Å‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î</h3>
                <div class="value">${totalUsers} ‡∫ó‡ªà‡∫≤‡∫ô</div>
            </div>
            <div class="stat-card" style="border-left: 5px solid var(--success);">
                <h3>üí∞ ‡ªÄ‡∫á‡∫¥‡∫ô‡ªÄ‡∫Å‡∫±‡∫ö‡ªÑ‡∫î‡ªâ‡ªÅ‡∫•‡ªâ‡∫ß</h3>
                <div class="value text-success">${formatMoney(totalCollected)}</div>
            </div>
            <div class="stat-card" style="border-left: 5px solid var(--danger);">
                <h3>üìâ ‡∫ç‡∫≠‡∫î‡∫Ñ‡ªâ‡∫≤‡∫á‡∫ä‡∫≥‡∫•‡∫∞</h3>
                <div class="value text-danger">${formatMoney(totalTarget - totalCollected)}</div>
            </div>
            <div class="stat-card" style="border-left: 5px solid var(--warning);">
                <h3>üìä ‡∫Ñ‡∫ß‡∫≤‡∫°‡∫Ñ‡∫∑‡∫ö‡ªú‡ªâ‡∫≤</h3>
                <div class="value">${percent.toFixed(1)}%</div>
                <div class="progress-bar"><div class="progress-fill" style="width:${percent}%"></div></div>
            </div>
        `;
    }

    function renderTable() {
        const search = document.getElementById('search').value.toLowerCase();
        const filter = document.getElementById('filter').value;
        const tbody = document.getElementById('list-body');
        
        let data = borrowers.filter(b => b.name.toLowerCase().includes(search));
        if (filter === 'pending') data = data.filter(b => getPaid(b) < TARGET_AMT);
        if (filter === 'paid') data = data.filter(b => getPaid(b) >= TARGET_AMT);

        tbody.innerHTML = data.map((b, index) => {
            const paid = getPaid(b);
            const bal = TARGET_AMT - paid;
            const isDone = bal <= 0;
            const percent = (paid / TARGET_AMT) * 100;

            return `
                <tr>
                    <td>${index + 1}</td>
                    <td>
                        <strong>${b.name}</strong><br>
                        <small style="color:#6b7280">üìû ${b.phone || '-'}</small>
                    </td>
                    <td>${b.dept || '-'}</td>
                    <td style="color: var(--success); font-weight:bold;">${formatMoney(paid)}</td>
                    <td style="color: var(--danger); font-weight:bold;">${bal > 0 ? formatMoney(bal) : '0'}</td>
                    <td>
                        <span class="badge ${isDone ? 'badge-success' : 'badge-danger'}">
                            ${isDone ? '‚úÖ ‡∫à‡ªà‡∫≤‡∫ç‡∫Ñ‡∫ª‡∫ö' : '‚è≥ ‡∫Ñ‡ªâ‡∫≤‡∫á‡∫ä‡∫≥‡∫•‡∫∞'}
                        </span>
                        ${!isDone ? `<div class="progress-bar" style="width:100px; height:4px; margin-top:5px;"><div class="progress-fill" style="width:${percent}%"></div></div>` : ''}
                    </td>
                    <td class="text-right">
                        <button class="btn btn-primary btn-sm" onclick="openDetail(${b.id})">üîç ‡∫•‡∫≤‡∫ç‡∫•‡∫∞‡∫≠‡∫Ω‡∫î</button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function openDetail(id) {
        const b = borrowers.find(x => x.id === id);
        const paid = getPaid(b);
        const bal = TARGET_AMT - paid;
        const isAdmin = currentUser.role === 'admin';

        let historyRows = b.payments.map((p, idx) => `
            <tr>
                <td>${p.date}</td>
                <td>${formatMoney(p.amount)}</td>
                <td style="color:#6b7280"><small>${p.note || '-'}</small></td>
                <td class="text-right">
                    ${isAdmin ? `
                        <button onclick="editPayment(${id}, ${idx})" style="border:none; background:none; color:#3b82f6; cursor:pointer; margin-right:10px;" title="‡ªÅ‡∫Å‡ªâ‡ªÑ‡∫Ç">‚úèÔ∏è</button>
                        <button onclick="deletePayment(${id}, ${idx})" style="border:none; background:none; color:red; cursor:pointer;" title="‡∫•‡∫ª‡∫ö">üóëÔ∏è</button>
                    ` : ''}
                </td>
            </tr>
        `).join('');

        if (b.payments.length === 0) historyRows = '<tr><td colspan="4" style="text-align:center; padding:20px;">‡∫ç‡∫±‡∫á‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫õ‡∫∞‡∫´‡∫ß‡∫±‡∫î‡∫Å‡∫≤‡∫ô‡∫ä‡∫≥‡∫•‡∫∞</td></tr>';

        const html = `
            <div style="background:#f0f9ff; padding:20px; border-radius:10px; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <h3 style="margin:0; color:var(--primary);">${b.name}</h3>
                    <p style="margin:5px 0 0 0; font-size:14px;">‡∫û‡∫∞‡ªÅ‡∫ô‡∫Å: ${b.dept || '-'}</p>
                </div>
                <div style="text-align:right;">
                    <div style="font-size:12px; color:#6b7280;">‡∫ç‡∫≠‡∫î‡∫Ñ‡ªâ‡∫≤‡∫á‡∫ä‡∫≥‡∫•‡∫∞</div>
                    <div style="font-size:24px; font-weight:bold; color:${bal>0?'var(--danger)':'var(--success)'}">${formatMoney(bal)}</div>
                </div>
            </div>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                ${bal > 0 ? `<button class="btn btn-success" style="flex:1" onclick="openPayModal(${id})">üí∞ ‡∫ä‡∫≥‡∫•‡∫∞‡ªÄ‡∫á‡∫¥‡∫ô</button>` : ''}
                ${isAdmin ? `<button class="btn btn-primary" onclick="openEditMember(${id})">‚úèÔ∏è ‡ªÅ‡∫Å‡ªâ‡ªÑ‡∫Ç‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô</button>` : ''}
                ${isAdmin ? `<button class="btn btn-danger" onclick="deleteMember(${id})">üóëÔ∏è ‡∫•‡∫ª‡∫ö</button>` : ''}
            </div>
            <h4 style="border-bottom:1px solid #eee; padding-bottom:10px;">üìú ‡∫õ‡∫∞‡∫´‡∫ß‡∫±‡∫î‡∫Å‡∫≤‡∫ô‡∫ä‡∫≥‡∫•‡∫∞</h4>
            <div style="max-height:300px; overflow-y:auto;">
                <table>
                    <thead><tr><th>‡∫ß‡∫±‡∫ô‡∫ó‡∫µ</th><th>‡∫à‡∫≥‡∫ô‡∫ß‡∫ô</th><th>‡ªù‡∫≤‡∫ç‡ªÄ‡∫´‡∫î</th><th>‡∫à‡∫±‡∫î‡∫Å‡∫≤‡∫ô</th></tr></thead>
                    <tbody>${historyRows}</tbody>
                </table>
            </div>
        `;
        showModal('‡∫•‡∫≤‡∫ç‡∫•‡∫∞‡∫≠‡∫Ω‡∫î‡∫™‡∫∞‡∫°‡∫≤‡∫ä‡∫¥‡∫Å', html);
    }

    async function editPayment(memberId, payIdx) {
        const b = borrowers.find(x => x.id === memberId);
        const currentPay = b.payments[payIdx];

        const { value: newAmt } = await Swal.fire({
            title: '‡ªÅ‡∫Å‡ªâ‡ªÑ‡∫Ç‡∫à‡∫≥‡∫ô‡∫ß‡∫ô‡ªÄ‡∫á‡∫¥‡∫ô',
            input: 'number',
            inputLabel: '‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫õ‡ªâ‡∫≠‡∫ô‡∫à‡∫≥‡∫ô‡∫ß‡∫ô‡ªÄ‡∫á‡∫¥‡∫ô‡∫ó‡∫µ‡ªà‡∫ñ‡∫∑‡∫Å‡∫ï‡ªâ‡∫≠‡∫á',
            inputValue: currentPay.amount,
            showCancelButton: true,
            confirmButtonText: '‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å',
            cancelButtonText: '‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å',
            confirmButtonColor: '#10b981',
            inputValidator: (value) => {
                if (!value || value <= 0) {
                    return '‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫õ‡ªâ‡∫≠‡∫ô‡∫à‡∫≥‡∫ô‡∫ß‡∫ô‡ªÄ‡∫á‡∫¥‡∫ô‡∫ó‡∫µ‡ªà‡∫´‡∫º‡∫≤‡∫ç‡∫Å‡∫ß‡ªà‡∫≤ 0!';
                }
            }
        });

        if (newAmt) {
            b.payments[payIdx].amount = parseFloat(newAmt);
            save(); 
            openDetail(memberId); 
            const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000 });
            Toast.fire({ icon: 'success', title: '‡ªÅ‡∫Å‡ªâ‡ªÑ‡∫Ç‡∫à‡∫≥‡∫ô‡∫ß‡∫ô‡ªÄ‡∫á‡∫¥‡∫ô‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î‡ªÅ‡∫•‡ªâ‡∫ß' });
        }
    }

    async function openPayModal(id) {
        const b = borrowers.find(x => x.id === id);
        const bal = TARGET_AMT - getPaid(b);
        const { value: formValues } = await Swal.fire({
            title: '‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫Å‡∫≤‡∫ô‡∫ä‡∫≥‡∫•‡∫∞',
            html: `
                <input id="swal-amt" class="swal2-input" type="number" placeholder="‡∫à‡∫≥‡∫ô‡∫ß‡∫ô‡ªÄ‡∫á‡∫¥‡∫ô" value="${bal}">
                <input id="swal-date" class="swal2-input" type="date" value="${new Date().toISOString().split('T')[0]}">
                <input id="swal-note" class="swal2-input" placeholder="‡ªù‡∫≤‡∫ç‡ªÄ‡∫´‡∫î (‡∫ñ‡ªâ‡∫≤‡∫°‡∫µ)">
            `,
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonText: '‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å',
            preConfirm: () => {
                return {
                    amt: document.getElementById('swal-amt').value,
                    date: document.getElementById('swal-date').value,
                    note: document.getElementById('swal-note').value
                }
            }
        });
        if (formValues && formValues.amt > 0) {
            b.payments.push({
                amount: parseFloat(formValues.amt),
                date: formatDate(formValues.date),
                note: formValues.note
            });
            save();
            Swal.fire('‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î', '‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫Å‡∫≤‡∫ô‡∫ä‡∫≥‡∫•‡∫∞‡∫Æ‡∫Ω‡∫ö‡∫Æ‡ªâ‡∫≠‡∫ç', 'success');
            openDetail(id);
        }
    }

    function deletePayment(memberId, payIdx) {
        Swal.fire({
            title: '‡∫¢‡∫∑‡∫ô‡∫¢‡∫±‡∫ô?',
            text: "‡∫ï‡ªâ‡∫≠‡∫á‡∫Å‡∫≤‡∫ô‡∫•‡∫ª‡∫ö‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô‡∫ä‡∫≥‡∫•‡∫∞‡∫ô‡∫µ‡ªâ‡∫ö‡ªç‡ªà?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: '‡∫•‡∫ª‡∫ö‡ªÄ‡∫•‡∫µ‡∫ç'
        }).then((result) => {
            if (result.isConfirmed) {
                const b = borrowers.find(x => x.id === memberId);
                b.payments.splice(payIdx, 1);
                save();
                openDetail(memberId);
            }
        });
    }

    function openAddModal() {
        const html = `
            <div class="login-input-group">
                <label>‡∫ä‡∫∑‡ªà ‡ªÅ‡∫•‡∫∞ ‡∫ô‡∫≤‡∫°‡∫™‡∫∞‡∫Å‡∫∏‡∫ô</label>
                <input type="text" id="new-name" class="login-input">
                <label>‡ªÄ‡∫ö‡∫µ‡ªÇ‡∫ó‡∫•‡∫∞‡∫™‡∫±‡∫ö</label>
                <input type="text" id="new-phone" class="login-input">
                <label>‡∫û‡∫∞‡ªÅ‡∫ô‡∫Å</label>
                <input type="text" id="new-dept" class="login-input">
                <button class="btn btn-primary" style="width:100%; margin-top:15px;" onclick="addMember()">‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å</button>
            </div>
        `;
        showModal('‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫™‡∫∞‡∫°‡∫≤‡∫ä‡∫¥‡∫Å‡ªÉ‡ªù‡ªà', html);
    }

    function addMember() {
        const name = document.getElementById('new-name').value;
        const phone = document.getElementById('new-phone').value;
        const dept = document.getElementById('new-dept').value;
        if(!name) return Swal.fire('‡ªÅ‡∫à‡ªâ‡∫á‡ªÄ‡∫ï‡∫∑‡∫≠‡∫ô', '‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡ªÉ‡∫™‡ªà‡∫ä‡∫∑‡ªà!', 'warning');
        borrowers.push({ id: Date.now(), name, phone, dept, payments: [] });
        save(); closeModal();
        Swal.fire('‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î', '‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫™‡∫∞‡∫°‡∫≤‡∫ä‡∫¥‡∫Å‡ªÅ‡∫•‡ªâ‡∫ß', 'success');
    }

    function openEditMember(id) {
        const b = borrowers.find(x => x.id === id);
        const html = `
            <label>‡∫ä‡∫∑‡ªà</label><input id="edt-name" class="login-input" value="${b.name}">
            <label>‡ªÄ‡∫ö‡∫µ‡ªÇ‡∫ó</label><input id="edt-phone" class="login-input" value="${b.phone}">
            <label>‡∫û‡∫∞‡ªÅ‡∫ô‡∫Å</label><input id="edt-dept" class="login-input" value="${b.dept}">
            <button class="btn btn-success" style="width:100%; margin-top:10px" onclick="saveEdit(${id})">üíæ ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫Å‡∫≤‡∫ô‡ªÅ‡∫Å‡ªâ‡ªÑ‡∫Ç</button>
        `;
        showModal('‡ªÅ‡∫Å‡ªâ‡ªÑ‡∫Ç‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô', html);
    }

    function saveEdit(id) {
        const b = borrowers.find(x => x.id === id);
        b.name = document.getElementById('edt-name').value;
        b.phone = document.getElementById('edt-phone').value;
        b.dept = document.getElementById('edt-dept').value;
        save(); closeModal(); openDetail(id);
    }

    function deleteMember(id) {
        Swal.fire({
            title: '‡ªù‡∫±‡ªâ‡∫ô‡ªÉ‡∫à‡∫ö‡ªç‡ªà?', text: "‡∫Å‡∫≤‡∫ô‡∫•‡∫ª‡∫ö‡∫à‡∫∞‡∫ö‡ªç‡ªà‡∫™‡∫≤‡∫°‡∫≤‡∫î‡∫Å‡∫π‡ªâ‡∫Ñ‡∫∑‡∫ô‡ªÑ‡∫î‡ªâ!", icon: 'warning',
            showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: '‡∫¢‡∫∑‡∫ô‡∫¢‡∫±‡∫ô‡∫•‡∫ª‡∫ö'
        }).then((result) => {
            if (result.isConfirmed) {
                borrowers = borrowers.filter(b => b.id !== id);
                save(); closeModal();
                Swal.fire('‡∫•‡∫ª‡∫ö‡ªÅ‡∫•‡ªâ‡∫ß', '‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫ñ‡∫∑‡∫Å‡∫•‡∫ª‡∫ö‡∫≠‡∫≠‡∫Å‡∫•‡∫∞‡∫ö‡∫ª‡∫ö', 'success');
            }
        });
    }

    function exportExcel() {
        if(borrowers.length === 0) return Swal.fire('Info', '‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫ó‡∫µ‡ªà‡∫à‡∫∞ Export', 'info');
        const data = borrowers.map((b, i) => {
            const paid = getPaid(b);
            return {
                "‡∫•‡∫≥‡∫î‡∫±‡∫ö": i + 1, "‡∫ä‡∫∑‡ªà ‡ªÅ‡∫•‡∫∞ ‡∫ô‡∫≤‡∫°‡∫™‡∫∞‡∫Å‡∫∏‡∫ô": b.name, "‡ªÄ‡∫ö‡∫µ‡ªÇ‡∫ó": b.phone, "‡∫û‡∫∞‡ªÅ‡∫ô‡∫Å": b.dept,
                "‡∫ç‡∫≠‡∫î‡ªÄ‡∫õ‡∫ª‡ªâ‡∫≤‡ªù‡∫≤‡∫ç": TARGET_AMT, "‡∫à‡ªà‡∫≤‡∫ç‡ªÅ‡∫•‡ªâ‡∫ß": paid, "‡∫Ñ‡ªâ‡∫≤‡∫á‡∫ä‡∫≥‡∫•‡∫∞": TARGET_AMT - paid,
                "‡∫™‡∫∞‡∫ñ‡∫≤‡∫ô‡∫∞": (TARGET_AMT - paid) <= 0 ? "‡∫à‡ªà‡∫≤‡∫ç‡∫Ñ‡∫ª‡∫ö" : "‡∫Ñ‡ªâ‡∫≤‡∫á‡∫ä‡∫≥‡∫•‡∫∞"
            };
        });
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "‡∫•‡∫≤‡∫ç‡∫á‡∫≤‡∫ô‡ªÄ‡∫á‡∫¥‡∫ô‡∫Å‡∫π‡ªâ");
        XLSX.writeFile(wb, `Loan_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
    }

    function openAdminPanel() {
        let rows = users.map(u => `
            <tr>
                <td>${u.username}</td>
                <td>${u.role}</td>
                <td class="text-right">
                    ${u.role !== 'admin' ? `<button class="btn btn-danger btn-sm" onclick="delUser('${u.username}')">‡∫•‡∫ª‡∫ö</button>` : '<small>Main</small>'}
                </td>
            </tr>`).join('');
        
        const html = `
            <table class="table-sm"><thead><tr><th>User</th><th>Role</th><th></th></tr></thead><tbody>${rows}</tbody></table>
            <hr>
            <h4>‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫ú‡∫π‡ªâ‡ªÉ‡∫ä‡ªâ‡∫á‡∫≤‡∫ô</h4>
            <div style="display:flex; gap:5px; margin-bottom:15px;">
                <input id="new-u" placeholder="User" class="login-input" style="margin:0">
                <input id="new-p" placeholder="Pass" class="login-input" style="margin:0">
                <button class="btn btn-primary" onclick="addUser()">+</button>
            </div>
            <hr>
            <h4>üóÑÔ∏è ‡∫à‡∫±‡∫î‡∫Å‡∫≤‡∫ô‡∫ñ‡∫≤‡∫ô‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô</h4>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                <button class="btn btn-success" onclick="backupData()">üì• Backup</button>
                <button class="btn btn-warning" onclick="triggerRestore()">üì§ Restore</button>
            </div>
            <input type="file" id="restore-file" style="display:none" onchange="restoreData(event)" accept=".json">
        `;
        showModal('‡∫ï‡∫±‡ªâ‡∫á‡∫Ñ‡ªà‡∫≤‡∫ú‡∫π‡ªâ‡ªÉ‡∫ä‡ªâ‡∫•‡∫∞‡∫ö‡∫ª‡∫ö', html);
    }

    function addUser() {
        const u = document.getElementById('new-u').value;
        const p = document.getElementById('new-p').value;
        if(u && p) { users.push({ username: u, password: p, role: 'staff' }); save(); openAdminPanel(); }
    }
    
    function delUser(username) {
        if(confirm('‡∫•‡∫ª‡∫ö‡∫ú‡∫π‡ªâ‡ªÉ‡∫ä‡ªâ‡∫ô‡∫µ‡ªâ?')) { users = users.filter(u => u.username !== username); save(); openAdminPanel(); }
    }

    function backupData() {
        const dataToBackup = {
            borrowers: JSON.parse(localStorage.getItem(STORAGE_KEY)) || [],
            users: JSON.parse(localStorage.getItem(USERS_KEY)) || []
        };
        const dateStr = new Date().toLocaleDateString('en-GB').split('/').reverse().join('-');
        const fileName = `Data_lsfc-kmb_2026_${dateStr}.json`;
        const blob = new Blob([JSON.stringify(dataToBackup, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = fileName;
        link.click();
        Swal.fire('‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î', '‡∫™‡∫≥‡∫Æ‡∫≠‡∫á‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫Æ‡∫Ω‡∫ö‡∫Æ‡ªâ‡∫≠‡∫ç‡ªÅ‡∫•‡ªâ‡∫ß', 'success');
    }

    function triggerRestore() { document.getElementById('restore-file').click(); }

    function restoreData(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedData = JSON.parse(e.target.result);
                if (!importedData.borrowers || !importedData.users) throw new Error('‡∫Æ‡∫π‡∫ö‡ªÅ‡∫ö‡∫ö‡ªÑ‡∫ü‡∫•‡ªå‡∫ö‡ªç‡ªà‡∫ñ‡∫∑‡∫Å‡∫ï‡ªâ‡∫≠‡∫á');
                Swal.fire({
                    title: '‡∫¢‡∫∑‡∫ô‡∫¢‡∫±‡∫ô‡∫Å‡∫≤‡∫ô‡∫Å‡∫π‡ªâ‡∫Ñ‡∫∑‡∫ô?',
                    text: "‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫õ‡∫±‡∫î‡∫à‡∫∏‡∫ö‡∫±‡∫ô‡∫à‡∫∞‡∫ñ‡∫∑‡∫Å‡ªÅ‡∫ó‡∫ô‡∫ó‡∫µ‡ªà‡∫î‡ªâ‡∫ß‡∫ç‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫à‡∫≤‡∫Å‡ªÑ‡∫ü‡∫•‡ªå‡∫ô‡∫µ‡ªâ!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#f59e0b',
                    confirmButtonText: '‡∫¢‡∫∑‡∫ô‡∫¢‡∫±‡∫ô, ‡∫Å‡∫π‡ªâ‡∫Ñ‡∫∑‡∫ô‡ªÄ‡∫•‡∫µ‡∫ç',
                    cancelButtonText: '‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å'
                }).then((result) => {
                    if (result.isConfirmed) {
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(importedData.borrowers));
                        localStorage.setItem(USERS_KEY, JSON.stringify(importedData.users));
                        Swal.fire('‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î', '‡∫Å‡∫π‡ªâ‡∫Ñ‡∫∑‡∫ô‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫Æ‡∫Ω‡∫ö‡∫Æ‡ªâ‡∫≠‡∫ç‡ªÅ‡∫•‡ªâ‡∫ß! ‡∫•‡∫∞‡∫ö‡∫ª‡∫ö‡∫à‡∫∞ Restart', 'success').then(() => {
                            location.reload();
                        });
                    }
                });
            } catch (err) { Swal.fire('‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î', '‡∫ö‡ªç‡ªà‡∫™‡∫≤‡∫°‡∫≤‡∫î‡∫≠‡ªà‡∫≤‡∫ô‡ªÑ‡∫ü‡∫•‡ªå‡∫ô‡∫µ‡ªâ‡ªÑ‡∫î‡ªâ: ' + err.message, 'error'); }
        };
        reader.readAsText(file);
        event.target.value = '';
    }

    function formatMoney(amount) { return new Intl.NumberFormat('lo-LA', { style: 'currency', currency: 'LAK' }).format(amount); }
    function formatDate(dateStr) {
        if(!dateStr) return new Date().toLocaleDateString('en-GB');
        const [y, m, d] = dateStr.split('-');
        return `${d}/${m}/${y}`;
    }
    function showModal(title, html) {
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-body').innerHTML = html;
        document.getElementById('modal').style.display = 'block';
    }
    function closeModal() { document.getElementById('modal').style.display = 'none'; }
    window.onclick = function(event) { if (event.target == document.getElementById('modal')) closeModal(); }
</script>
</body>
</html>